# Opentrons Protocol Sanity Check System - 要件定義書

## 1. プロジェクト概要

Opentrons実験プロトコルファイル(.py)を解析し、物理セッティングのチェックポイントを自動生成。人間が行ったセッティングの画像をAIで検証し、ミスがないかを判定するシステム。

## 2. システムアーキテクチャ

```
[フロントエンド (Web UI)]
    ↓ ファイルアップロード (.py + 画像1枚)
[バックエンド (FastAPI)]
    ↓ API呼び出し
[Gemini 2.5 Pro API]
  - フェーズ1: プロトコル解析 → チェックポイント生成
  - フェーズ2: 画像検証 → 各項目の○×判定
    ↓ 結果返却
[フロントエンド]
  - チェック項目と結果を表示
```

## 3. 機能要件

### 3.1 ファイルアップロード機能

- Opentrons プロトコルファイル (.py) のアップロード
- セッティング画像 (jpg/png) 1枚のアップロード
- ファイル形式のバリデーション

### 3.2 チェックポイント生成機能（Gemini APIフェーズ1）

- プロトコルファイルを解析
- 物理セッティングで確認すべきチェックポイントを生成
- チェックポイント例：
    - はじめにC2にピペットチップラックがあるか
    - C2内のすべてのピペットチップが埋まっているか
    - 無駄な場所にケースが置かれていないか
    - その他プロトコル固有の要件

### 3.3 画像検証機能（Gemini APIフェーズ2）

- 生成されたチェックポイントをもとに画像を検証
- 各チェック項目ごとに○（合格）または×（不合格）を判定
- 不合格の場合は理由を記載

### 3.4 結果表示機能

- チェック項目一覧の表示
- 各項目の判定結果（○×）を表示
- 総合判定（全項目合格/不合格あり）
- 不合格項目の詳細説明

## 4. 技術スタック

### フロントエンド

- HTML/CSS/JavaScript（シンプルUI）
- またはReact/Vue.js（将来拡張を考慮する場合）

### バックエンド

- Python 3.10+
- FastAPI（Web APIフレームワーク）
- Google Generative AI SDK（Gemini API）
- Uvicorn（ASGIサーバー）

### その他

- dotenv（環境変数管理）
- Pillow（画像処理用、必要に応じて）

## 5. 処理フロー

### 5.1 全体フロー

1. ユーザーがWeb UIでプロトコルファイル(.py)と画像をアップロード
2. バックエンドがファイルを受信
3. Gemini APIに対してSystem Promptとプロトコルファイルを送信（フェーズ1）
4. Geminiがチェックポイントを生成（JSON形式で返却）
5. 同じセッション（コンテキスト保持）で画像を追加送信（フェーズ2）
6. Geminiが各チェックポイントを検証し、結果を返却（JSON形式）
7. バックエンドが結果を整形してフロントエンドに返却
8. UIに検証結果を表示

### 5.2 Gemini API呼び出し詳細

**フェーズ1: チェックポイント生成**

- System Instruction: プロトコル解析とチェックポイント生成の指示
- Input: プロトコルファイルの内容（テキスト）
- Output: チェックポイントリスト（JSON）

**フェーズ2: 画像検証**

- 同じチャットセッション（コンテキスト継続）
- Input: セッティング画像
- Output: 各チェックポイントの検証結果（JSON）

## 6. チェックポイント定義（System Instructionに含める）

デフォルトのチェック項目例：

1. C2にピペットチップラックが配置されているか
2. C2内のすべてのピペットチップが正しく埋まっているか
3. A3にゴミ箱（trash bin）が配置されているか
4. 不要な場所にラボウェアが置かれていないか
5. プロトコルで指定された他のラボウェアが正しい位置にあるか

## 7. 入出力仕様

### 7.1 API入力

- プロトコルファイル: `.py`形式（multipart/form-data）
- 画像ファイル: `.jpg` or `.png`（multipart/form-data）

### 7.2 API出力（JSON）

```json
{
  "success": true,
  "checkpoints": [
    {
      "id": 1,
      "description": "C2にピペットチップラックが配置されているか",
      "result": "pass",
      "details": ""
    },
    {
      "id": 2,
      "description": "C2内のすべてのピペットチップが正しく埋まっているか",
      "result": "fail",
      "details": "左下のピペットチップが不足しています"
    }
  ],
  "overall_result": "fail"
}
```

### 7.3 UI表示

- チェックポイント一覧（番号、説明、結果アイコン）
- 総合判定（大きく表示）
- 不合格項目の詳細説明

## 8. ファイル構成（予定）

```
sanitycheckAI/
├── README.md              # システム説明、セットアップ手順
├── requirements.txt       # Python依存関係
├── .env.example          # 環境変数テンプレート
├── backend/
│   ├── main.py           # FastAPIアプリケーション
│   ├── gemini_service.py # Gemini API連携
│   └── prompts.py        # System Instruction定義
├── frontend/
│   ├── index.html        # メインUI
│   ├── style.css         # スタイル
│   └── script.js         # フロントエンドロジック
└── docs/
    └── requirements.md   # 本要件定義書
```

## 9. 実装優先順位

1. 要件定義書作成（本ドキュメント）
2. バックエンドAPIの実装（FastAPI + Gemini API連携）
3. System Instruction & Prompt設計
4. フロントエンドUI実装
5. 統合テスト（good_photo_1.jpg、bad_photo_*.jpgで検証）
6. ドキュメント整備

## 10. 制約事項・前提条件

- 画像の事前処理は行わない（Gemini APIに直接渡す）
- 1回の検証につき画像1枚のみ
- Gemini 2.5 Pro APIキーが必要
- インターネット接続必須
- プロトコルファイルはOpentrons API 2.xフォーマット

## 11. 将来的な拡張可能性

- 複数画像の同時検証
- カスタムチェックポイントの追加UI
- 検証履歴の保存
- 画像アノテーション（問題箇所のハイライト）
- 他のロボットプラットフォームへの対応

